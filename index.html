<!--Strona HTML/CSS/JS wyświetlająca dane z pliku .csv oraz tworząca wykres:-->
<!doctype html>
<html lang="pl">
    <head>
        <meta charset="UTF-8" />
        <title>
            Dashboard – Kursy walut, kryptowalut, indeksów giełdowych i spółek
        </title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            /* STYLES – niezmienione */
            :root {
                color-scheme: light dark;
            }
            body {
                font-family: Arial, sans-serif;
                margin: 1em;
                background-color: #121212;
                color: #e0e0e0;
            }
            input[type="text"],
            input[type="date"],
            select {
                margin: 0.5em 0;
                padding: 6px 10px;
                font-size: 1em;
                background-color: #2a2a2a;
                color: #ffffff;
                border: 1px solid #555;
                border-radius: 4px;
            }
            .controls {
                display: flex;
                flex-direction: column;
                gap: 0.5em;
                align-items: flex-start;
            }
            @media (min-width: 768px) {
                .controls {
                    flex-direction: row;
                    flex-wrap: wrap;
                    align-items: center;
                }
            }
            table {
                border-collapse: collapse;
                width: 100%;
                margin-top: 1em;
            }
            th,
            td {
                padding: 6px 12px;
                border: 1px solid #555;
                text-align: right;
            }
            th {
                background-color: #1e1e1e;
                text-align: center;
                cursor: pointer;
            }
            td:first-child,
            th:first-child {
                text-align: left;
            }
            tr.hidden {
                display: none;
            }
            canvas {
                max-width: 100%;
                margin-top: 40px;
                background-color: white;
            }
            .export-button,
            .toggle-button,
            .theme-button,
            .svg-button {
                margin: 0.5em 0;
                padding: 10px 20px;
                background-color: #007bff;
                color: white;
                border: none;
                cursor: pointer;
                border-radius: 4px;
            }
            .export-button:hover,
            .toggle-button:hover,
            .theme-button:hover,
            .svg-button:hover {
                background-color: #0056b3;
            }
        </style>
    </head>
    <body>
        <h1>Kursy walut, kryptowalut, indeksów giełdowych i spółek</h1>
        <p>Wersja 1.3</p>
        <p>
            Autor: Tomasz Lebioda,
            <a href="mailto:tomasz.lebioda@wyborcza.pl"
                >tomasz.lebioda@wyborcza.pl</a
            >
        </p>
        <div class="controls">
            <input type="text" id="search" placeholder="Szukaj w tabeli..." />
            <label>Eksport od: <input type="date" id="exportFrom" /></label>
            <label>do: <input type="date" id="exportTo" /></label>
            <label>Wykres od: <input type="date" id="chartFrom" /></label>
            <label>do: <input type="date" id="chartTo" /></label>
            <select id="indexSelect" multiple size="6"></select>
            <button class="export-button" onclick="exportTableToCSV()">
                Eksportuj do CSV
            </button>
            <button class="svg-button" onclick="exportChartToSVG()">
                Eksportuj wykres do SVG
            </button>
            <button class="toggle-button" onclick="toggleTable()">
                Pokaż/Ukryj tabelę
            </button>
            <button class="theme-button" onclick="toggleTheme()">
                Przełącz motyw
            </button>
        </div>

        <table id="indexTable"></table>
        <canvas id="chart"></canvas>

        <script>
            let fullData = [],
                headers = [],
                tableVisible = true,
                darkTheme = true;

            // PLIK CSV
            fetch("gw-scraped-data.csv")
                .then((response) => response.text())
                .then((csvData) => {
                    const parsed = Papa.parse(csvData.trim(), { header: true });
                    fullData = parsed.data;
                    headers = parsed.meta.fields;

                    const table = document.getElementById("indexTable");
                    const thead = document.createElement("tr");
                    headers.forEach((header, i) => {
                        const th = document.createElement("th");
                        th.textContent = header;
                        th.addEventListener("click", () => sortTable(table, i));
                        thead.appendChild(th);
                    });
                    table.appendChild(thead);
                    fullData.forEach((row) => {
                        const tr = document.createElement("tr");
                        headers.forEach((header) => {
                            const td = document.createElement("td");
                            td.textContent = row[header] || "-";
                            tr.appendChild(td);
                        });
                        table.appendChild(tr);
                    });

                    const select = document.getElementById("indexSelect");
                    headers.slice(1).forEach((h) => {
                        const option = document.createElement("option");
                        option.value = h;
                        option.textContent = h;
                        option.selected = true;
                        select.appendChild(option);
                    });

                    select.addEventListener("change", () => {
                        const selected = Array.from(select.selectedOptions).map(
                            (o) => o.value,
                        );
                        updateChart(selected);
                        localStorage.setItem(
                            "selectedIndices",
                            JSON.stringify(selected),
                        );
                    });

                    document
                        .getElementById("chartFrom")
                        .addEventListener("change", () =>
                            updateChart(
                                Array.from(select.selectedOptions).map(
                                    (o) => o.value,
                                ),
                            ),
                        );
                    document
                        .getElementById("chartTo")
                        .addEventListener("change", () =>
                            updateChart(
                                Array.from(select.selectedOptions).map(
                                    (o) => o.value,
                                ),
                            ),
                        );

                    const saved = JSON.parse(
                        localStorage.getItem("selectedIndices") || "[]",
                    );
                    if (saved.length > 0) {
                        Array.from(select.options).forEach((opt) => {
                            opt.selected = saved.includes(opt.value);
                        });
                    }

                    updateChart(
                        Array.from(select.selectedOptions).map((o) => o.value),
                    );
                });

            function sortTable(table, colIndex) {
                const rows = Array.from(table.rows).slice(1);
                const isNumeric = !isNaN(
                    rows.find((r) => r.cells[colIndex].textContent.trim())
                        ?.cells[colIndex].textContent,
                );
                const sorted = rows.sort((a, b) => {
                    const aText = a.cells[colIndex].textContent.trim();
                    const bText = b.cells[colIndex].textContent.trim();
                    if (isNumeric) return parseFloat(aText) - parseFloat(bText);
                    return aText.localeCompare(bText);
                });
                rows.forEach((row) => table.appendChild(row));
            }

            function toggleTable() {
                const table = document.getElementById("indexTable");
                tableVisible = !tableVisible;
                table.style.display = tableVisible ? "table" : "none";
            }

            function toggleTheme() {
                darkTheme = !darkTheme;
                document.body.style.backgroundColor = darkTheme
                    ? "#121212"
                    : "#ffffff";
                document.body.style.color = darkTheme ? "#e0e0e0" : "#000000";
            }

            function exportTableToCSV() {
                const from = document.getElementById("exportFrom").value;
                const to = document.getElementById("exportTo").value;
                const filtered = fullData.filter(
                    (row) =>
                        (!from || row.date >= from) && (!to || row.date <= to),
                );
                let csv = [headers.join(",")];
                filtered.forEach((row) => {
                    let line = headers
                        .map((h) => `"${row[h] || ""}"`)
                        .join(",");
                    csv.push(line);
                });
                const blob = new Blob([csv.join("\n")], {
                    type: "text/csv;charset=utf-8;",
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "crypto_data_filtered.csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportChartToSVG() {
                const canvas = document.getElementById("chart");
                const image = new Image();
                image.src = canvas.toDataURL("image/png");
                image.onload = function () {
                    const svg =
                        `<svg xmlns='http://www.w3.org/2000/svg' width='${canvas.width}' height='${canvas.height}'>` +
                        `<image href='${image.src}' width='${canvas.width}' height='${canvas.height}'/></svg>`;
                    const blob = new Blob([svg], {
                        type: "image/svg+xml;charset=utf-8",
                    });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = "chart.svg";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
            }

            function updateChart(selectedIndices) {
                const ctx = document.getElementById("chart").getContext("2d");
                const chartFrom = document.getElementById("chartFrom").value;
                const chartTo = document.getElementById("chartTo").value;
                const filteredData = fullData.filter(
                    (row) =>
                        (!chartFrom || row.date >= chartFrom) &&
                        (!chartTo || row.date <= chartTo),
                );
                const labels = filteredData.map((row) => row.date);
                const datasets = selectedIndices.map((index, i) => ({
                    label: index,
                    data: filteredData.map((row) => {
                        const raw = row[index];
                        const num = parseFloat(raw);
                        return raw === '-' || raw === '' || isNaN(num) ? null : num;
                    }),
                    spanGaps: true,
                    borderWidth: 2,
                    borderColor: `hsl(${i * 60}, 70%, 50%)`,
                    backgroundColor: `hsla(${i * 60}, 70%, 70%, 0.2)`,
                    fill: true,
                    pointRadius: 0,
                    spanGaps: true,
                }));
                if (window.indexChart) window.indexChart.destroy();
                window.indexChart = new Chart(ctx, {
                    type: "line",
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        animation: false,
                        spanGaps: true,
                        scales: {
                            x: { title: { display: true, text: "Data" } },
                            y: {
                                title: {
                                    display: true,
                                    text: "Wartość (Close)",
                                },
                                beginAtZero: false,
                            },
                        },
                    },
                });
            }

            document
                .getElementById("search")
                .addEventListener("input", function () {
                    const query = this.value.toLowerCase();
                    const rows = document.querySelectorAll(
                        "#indexTable tr:not(:first-child)",
                    );
                    rows.forEach((row) => {
                        const text = row.textContent.toLowerCase();
                        row.classList.toggle("hidden", !text.includes(query));
                    });
                });
        </script>
    </body>
</html>
